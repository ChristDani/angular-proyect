<!-- src/app/transfers/transfer-to-third.dialog.html -->
<h3 mat-dialog-title class="dialog-title">Transferir dinero a terceros</h3>

<div mat-dialog-content class="dialog-content">

  @if (loading()) {
    <div class="state soft">Cargando cuentas...</div>
  } @else if (error()) {
    <div class="state error">{{ error() }}</div>
  } @else {

    <form [formGroup]="form" class="form-root" (ngSubmit)="submit()">

      <!-- Desde -->
      <div class="field-title">Desde</div>
      <mat-form-field appearance="outline" class="w-100">
        <mat-select placeholder="Selecciona cuenta" formControlName="fromId">
          <mat-select-trigger>
            <div class="option-trigger">
              <span class="option-label">
                {{ from()?.type?.toUpperCase() || 'Cuenta' }}
                <small class="muted">••••{{ from()?.id?.slice(-4) }}</small>
              </span>
              <span class="balance" [class.negative]="(from()?.balance ?? 0) < 0">
                S/ {{ (from()?.balance ?? 0) | number:'1.2-2' }}
              </span>
            </div>
          </mat-select-trigger>

          @for (a of accounts(); track a.id) {
            <mat-option [value]="a.id">
              <div class="option-row">
                <span class="option-label">
                  {{ a.type?.toUpperCase() }}
                  <small class="muted">••••{{ a.id.slice(-4) }}</small>
                </span>
                <span class="balance" [class.negative]="a.balance < 0">
                  S/ {{ a.balance | number:'1.2-2' }}
                </span>
              </div>
            </mat-option>
          }
        </mat-select>
      </mat-form-field>

      <!-- Cuenta destino (manual) -->
      <div class="field-title">Cuenta destino</div>
      <mat-form-field appearance="outline" class="w-100">
        <input matInput placeholder="Ingrese número de cuenta" formControlName="toAccountId" />
        @if (form.get('toAccountId')?.hasError('accountNotFound') && form.get('toAccountId')?.touched) {
          <mat-error>La cuenta destino no existe.</mat-error>
        }
      </mat-form-field>

      <!-- Descripción (opcional) -->
      <div class="field-title">Descripción</div>
      <mat-form-field appearance="outline" class="w-100">
        <input matInput placeholder="Concepto (opcional)" formControlName="description" />
      </mat-form-field>

      <!-- Monto -->
      <div class="field-title">Monto</div>
      <mat-form-field appearance="outline" class="w-100">
        <span matTextPrefix>S/&nbsp;</span>
        <input
          matInput
          type="number"
          inputmode="decimal"
          step="0.01"
          min="0.01"
          placeholder="0.00"
          formControlName="amount" />
      </mat-form-field>

      @if (sameAccount()) {
        <div class="msg warning">La cuenta destino no puede ser la misma que la de origen.</div>
      }
      @if (insufficient()) {
        <div class="msg error">Saldo insuficiente en la cuenta de origen.</div>
      }

      <div mat-dialog-actions class="dialog-actions">
        <button mat-stroked-button color="primary" type="button" [disabled]="submitting()" (click)="close()">
          Cancelar
        </button>
        <button mat-flat-button color="primary" type="submit" [disabled]="!canSubmit()">
          @if (submitting()) { Procesando... } @else { Continuar }
        </button>
      </div>
    </form>
  }
</div>
